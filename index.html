<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïã UmrahCheck - Lokaler Funnel Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .funnel-step {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        .funnel-step.active {
            display: block;
        }
        
        .step-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 20px;
        }
        
        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-container {
            margin-top: 30px;
        }
        
        .flight-card {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .flight-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .airline {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
        }
        
        .price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .flight-details {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
        }
        
        .airport {
            text-align: center;
        }
        
        .airport-code {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        
        .airport-name {
            font-size: 0.9rem;
            color: #666;
        }
        
        .flight-arrow {
            text-align: center;
            color: #667eea;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e1e5e9;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #667eea;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .flight-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üïã UmrahCheck</h1>
            <p>Lokaler Funnel Test - Kompletter Booking-Workflow</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 25%"></div>
            </div>
        </div>

        <!-- Step 1: Flight Search -->
        <div class="funnel-step active" id="step1">
            <div class="step-header">
                <div class="step-number">1</div>
                <h2>‚úàÔ∏è Flugsuche</h2>
                <p>Finde die besten Umrah-Fl√ºge mit EUR-Preisen</p>
            </div>
            
            <form id="flightSearchForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="departure">üõ´ Abflughafen</label>
                        <select id="departure" name="departure" required>
                            <option value="">W√§hlen Sie einen Flughafen</option>
                            <option value="HAM">Hamburg (HAM)</option>
                            <option value="FRA">Frankfurt (FRA)</option>
                            <option value="MUC">M√ºnchen (MUC)</option>
                            <option value="DUS">D√ºsseldorf (DUS)</option>
                            <option value="BER">Berlin (BER)</option>
                            <option value="CGN">K√∂ln (CGN)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="arrival">üïã Zielflughafen</label>
                        <select id="arrival" name="arrival" required>
                            <option value="">W√§hlen Sie einen Flughafen</option>
                            <option value="JED">Jeddah (JED)</option>
                            <option value="RUH">Riyadh (RUH)</option>
                            <option value="MED">Medina (MED)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="departureDate">üìÖ Abflugdatum</label>
                        <input type="date" id="departureDate" name="departureDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="returnDate">üîÑ R√ºckflugdatum</label>
                        <input type="date" id="returnDate" name="returnDate">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="passengers">üë• Anzahl Passagiere</label>
                        <select id="passengers" name="passengers" required>
                            <option value="1">1 Passagier</option>
                            <option value="2" selected>2 Passagiere</option>
                            <option value="3">3 Passagiere</option>
                            <option value="4">4 Passagiere</option>
                            <option value="5">5 Passagiere</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="cabinClass">‚úàÔ∏è Klasse</label>
                        <select id="cabinClass" name="cabinClass">
                            <option value="economy" selected>Economy</option>
                            <option value="premium_economy">Premium Economy</option>
                            <option value="business">Business</option>
                        </select>
                    </div>
                </div>
                
                <button type="submit" class="btn" id="searchBtn">
                    üîç Fl√ºge suchen (mit EUR-Conversion)
                </button>
            </form>
            
            <div id="flightResults" class="results-container"></div>
        </div>

        <!-- Step 2: Lead Capture -->
        <div class="funnel-step" id="step2">
            <div class="step-header">
                <div class="step-number">2</div>
                <h2>üìã Ihre Kontaktdaten</h2>
                <p>F√ºr Ihr pers√∂nliches Umrah-Angebot</p>
            </div>
            
            <form id="leadForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">üë§ Vorname</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="lastName">üë§ Nachname</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">üìß E-Mail</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="whatsapp">üì± WhatsApp</label>
                        <input type="tel" id="whatsapp" name="whatsapp" placeholder="+49..." required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="budget">üí∞ Gesamtbudget (EUR)</label>
                    <select id="budget" name="budget" required>
                        <option value="">Budget w√§hlen</option>
                        <option value="1500">1.500‚Ç¨ - 2.000‚Ç¨</option>
                        <option value="2500">2.500‚Ç¨ - 3.000‚Ç¨</option>
                        <option value="3500">3.500‚Ç¨ - 4.000‚Ç¨</option>
                        <option value="4500">4.500‚Ç¨ - 5.000‚Ç¨</option>
                        <option value="6000">6.000‚Ç¨+</option>
                    </select>
                </div>
                
                <button type="submit" class="btn">
                    üí° Budget analysieren
                </button>
            </form>
        </div>

        <!-- Step 3: Budget Analysis -->
        <div class="funnel-step" id="step3">
            <div class="step-header">
                <div class="step-number">3</div>
                <h2>üí∞ Budget-Analyse</h2>
                <p>Optimale Aufteilung Ihres Umrah-Budgets</p>
            </div>
            
            <div id="budgetResults"></div>
            
            <button class="btn" onclick="nextStep(4)">
                üéØ Angebot erstellen
            </button>
        </div>

        <!-- Step 4: Payment -->
        <div class="funnel-step" id="step4">
            <div class="step-header">
                <div class="step-number">4</div>
                <h2>üí≥ Buchung abschlie√üen</h2>
                <p>Sichere Bezahlung √ºber Duffel Payments</p>
            </div>
            
            <div id="bookingSummary"></div>
            
            <button class="btn" id="paymentBtn">
                üí≥ Jetzt buchen (Lokaler Test)
            </button>
            
            <div id="paymentResults"></div>
        </div>
    </div>

    <script>
        // Global state
        let currentStep = 1;
        let searchData = {};
        let leadData = {};
        let selectedFlight = null;
        
        // API Base URLs
        const API_BASE = 'http://localhost:8000';
        const PAYMENT_BASE = 'http://localhost:8001';
        
        // Set minimum date to today
        document.getElementById('departureDate').min = new Date().toISOString().split('T')[0];
        document.getElementById('returnDate').min = new Date().toISOString().split('T')[0];
        
        // Update return date minimum when departure changes
        document.getElementById('departureDate').addEventListener('change', function() {
            document.getElementById('returnDate').min = this.value;
        });
        
        // Step 1: Flight Search
        document.getElementById('flightSearchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            searchData = {
                departure: formData.get('departure'),
                arrival: formData.get('arrival'),
                departure_date: formData.get('departureDate'),
                return_date: formData.get('returnDate') || null,
                passengers: parseInt(formData.get('passengers')),
                cabin_class: formData.get('cabinClass')
            };
            
            const btn = document.getElementById('searchBtn');
            const results = document.getElementById('flightResults');
            
            btn.disabled = true;
            btn.textContent = 'üîç Suche l√§uft...';
            
            results.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Durchsuche 300+ Airlines mit EUR-Conversion...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/api/duffel-search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(searchData)
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                displayFlightResults(data);
                
            } catch (error) {
                console.error('Flight search error:', error);
                results.innerHTML = `
                    <div class="status error">
                        ‚ùå Fehler bei der Flugsuche: ${error.message}
                        <br><br>
                        <strong>Troubleshooting:</strong>
                        <br>‚Ä¢ API Server l√§uft: http://localhost:8000/api/health
                        <br>‚Ä¢ Duffel Token konfiguriert
                        <br>‚Ä¢ CORS aktiviert
                    </div>
                `;
            }
            
            btn.disabled = false;
            btn.textContent = 'üîç Fl√ºge suchen (mit EUR-Conversion)';
        });
        
        function displayFlightResults(data) {
            const results = document.getElementById('flightResults');
            
            if (!data.success || !data.offers || data.offers.length === 0) {
                results.innerHTML = `
                    <div class="status error">
                        ‚ùå Keine Fl√ºge gefunden. Versuchen Sie andere Daten.
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="status success">
                    ‚úÖ ${data.count} Fl√ºge gefunden - Alle Preise in EUR mit UmrahCheck Markup!
                </div>
            `;
            
            data.offers.forEach((flight, index) => {
                const originalPrice = flight.price.original ? 
                    `<small style="text-decoration: line-through; color: #999;">
                        ${flight.price.original.amount.toFixed(2)} ${flight.price.original.currency}
                    </small><br>` : '';
                
                html += `
                    <div class="flight-card" onclick="selectFlight(${index}, ${JSON.stringify(flight).replace(/"/g, '&quot;')})">
                        <div class="flight-header">
                            <div class="airline">
                                ‚úàÔ∏è ${flight.airline} ${flight.flightNumber}
                            </div>
                            <div class="price">
                                ${originalPrice}
                                ${flight.price.total.toFixed(2)} EUR
                                <small>(${flight.price.perPerson.toFixed(2)} EUR/Person)</small>
                            </div>
                        </div>
                        
                        <div class="flight-details">
                            <div class="airport">
                                <div class="airport-code">${flight.departure.airport}</div>
                                <div class="airport-name">${flight.departure.city}</div>
                                <div class="airport-name">${new Date(flight.departure.time).toLocaleString('de-DE')}</div>
                            </div>
                            
                            <div class="flight-arrow">
                                ‚úàÔ∏è ${flight.duration}
                                <br>
                                ${flight.stops === 0 ? 'Direktflug' : flight.stops + ' Stopp(s)'}
                            </div>
                            
                            <div class="airport">
                                <div class="airport-code">${flight.arrival.airport}</div>
                                <div class="airport-name">${flight.arrival.city}</div> 
                                <div class="airport-name">${new Date(flight.arrival.time).toLocaleString('de-DE')}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                            üõ©Ô∏è ${flight.aircraft} ‚Ä¢ üí∫ ${flight.cabinClass}
                            ${flight.price.markup_applied ? ' ‚Ä¢ ‚úÖ EUR-Conversion aktiv' : ''}
                        </div>
                    </div>
                `;
            });
            
            results.innerHTML = html;
        }
        
        function selectFlight(index, flight) {
            selectedFlight = flight;
            
            // Highlight selected flight
            document.querySelectorAll('.flight-card').forEach(card => {
                card.style.backgroundColor = '';
                card.style.borderColor = '#e1e5e9';
            });
            
            event.currentTarget.style.backgroundColor = '#f7fafc';
            event.currentTarget.style.borderColor = '#667eea';
            
            // Show continue button
            const results = document.getElementById('flightResults');
            let continueBtn = document.getElementById('continueBtn');
            
            if (!continueBtn) {
                continueBtn = document.createElement('button');
                continueBtn.id = 'continueBtn';
                continueBtn.className = 'btn';
                continueBtn.innerHTML = '‚û°Ô∏è Weiter zur Buchung';
                continueBtn.onclick = () => nextStep(2);
                results.appendChild(continueBtn);
            }
        }
        
        // Step 2: Lead Capture
        document.getElementById('leadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            leadData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                whatsapp: formData.get('whatsapp'),
                budget: parseInt(formData.get('budget'))
            };
            
            // Calculate budget allocation
            await calculateBudget();
            nextStep(3);
        });
        
        async function calculateBudget() {
            try {
                const response = await fetch(`${API_BASE}/berechne-budget`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        gesamtbudget: leadData.budget,
                        personenanzahl: searchData.passengers,
                        abflughafen: searchData.departure,
                        reisezeit: "normal",
                        flexibilitaet: "normal"
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Budget API Error: ${response.status}`);
                }
                
                const budgetData = await response.json();
                displayBudgetResults(budgetData);
                
            } catch (error) {
                console.error('Budget calculation error:', error);
                document.getElementById('budgetResults').innerHTML = `
                    <div class="status error">
                        ‚ùå Budget-Berechnung fehlgeschlagen: ${error.message}
                    </div>
                `;
            }
        }
        
        function displayBudgetResults(budget) {
            const results = document.getElementById('budgetResults');
            
            results.innerHTML = `
                <div class="status success">
                    ‚úÖ Budget optimal aufgeteilt f√ºr ${searchData.passengers} Person(en)
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3>‚úàÔ∏è Fl√ºge</h3>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #667eea; margin: 10px 0;">
                            ${budget.budget_flug.toFixed(2)} EUR
                        </div>
                        <p style="font-size: 0.9rem; color: #666;">
                            ${(budget.budget_flug / searchData.passengers).toFixed(2)} EUR pro Person
                        </p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3>üïã Hotel Mekka</h3>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #667eea; margin: 10px 0;">
                            ${budget.budget_hotel_mekka.toFixed(2)} EUR
                        </div>
                        <p style="font-size: 0.9rem; color: #666;">
                            Ca. 5-7 N√§chte
                        </p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3>üåô Hotel Medina</h3>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #667eea; margin: 10px 0;">
                            ${budget.budget_hotel_medina.toFixed(2)} EUR
                        </div>
                        <p style="font-size: 0.9rem; color: #666;">
                            Ca. 3-4 N√§chte
                        </p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3>üìã Visum & Extras</h3>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #667eea; margin: 10px 0;">
                            ${budget.budget_visum_extras.toFixed(2)} EUR
                        </div>
                        <p style="font-size: 0.9rem; color: #666;">
                            Visum, Transfer, etc.
                        </p>
                    </div>
                </div>
                
                <div style="background: #667eea; color: white; padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px;">
                    <h3>üí∞ Gesamtbudget</h3>
                    <div style="font-size: 2rem; font-weight: bold; margin: 10px 0;">
                        ${budget.gesamtbudget.toFixed(2)} EUR
                    </div>
                    <p>${budget.empfehlung}</p>
                </div>
            `;
        }
        
        // Payment flow
        document.getElementById('paymentBtn').addEventListener('click', async function() {
            const btn = this;
            const results = document.getElementById('paymentResults');
            
            btn.disabled = true;
            btn.textContent = 'üí≥ Erstelle Payment...';
            
            try {
                const paymentData = {
                    offer_id: selectedFlight.duffel_raw_id,
                    passengers: Array(searchData.passengers).fill().map((_, i) => ({
                        title: "mr",
                        given_name: leadData.firstName,
                        family_name: leadData.lastName,
                        type: "adult"
                    })),
                    contact_info: {
                        email: leadData.email,
                        phone: leadData.whatsapp
                    },
                    amount: selectedFlight.price.total,
                    currency: "EUR"
                };
                
                const response = await fetch(`${PAYMENT_BASE}/create-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });
                
                if (!response.ok) {
                    throw new Error(`Payment API Error: ${response.status}`);
                }
                
                const payment = await response.json();
                displayPaymentResults(payment);
                
            } catch (error) {
                console.error('Payment error:', error);
                results.innerHTML = `
                    <div class="status error">
                        ‚ùå Payment-Erstellung fehlgeschlagen: ${error.message}
                    </div>
                `;
            }
            
            btn.disabled = false;
            btn.textContent = 'üí≥ Jetzt buchen (Lokaler Test)';
        });
        
        function displayPaymentResults(payment) {
            const results = document.getElementById('paymentResults');
            
            results.innerHTML = `
                <div class="status success">
                    ‚úÖ Payment erfolgreich erstellt!
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3>üìã Buchungsdetails</h3>
                    <p><strong>Payment ID:</strong> ${payment.payment_id}</p>
                    <p><strong>Booking Reference:</strong> ${payment.booking_reference}</p>
                    <p><strong>Betrag:</strong> ${payment.amount} ${payment.currency}</p>
                    <p><strong>Status:</strong> ${payment.status}</p>
                    
                    <div style="margin-top: 20px;">
                        <h4>üß™ Lokale Test-Aktionen:</h4>
                        <button class="btn" onclick="simulatePayment('${payment.payment_id}', 'success')" 
                                style="background: #28a745; margin: 5px;">
                            ‚úÖ Payment erfolgreich simulieren
                        </button>
                        <button class="btn" onclick="simulatePayment('${payment.payment_id}', 'failure')" 
                                style="background: #dc3545; margin: 5px;">
                            ‚ùå Payment-Fehler simulieren
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function simulatePayment(paymentId, type) {
            try {
                const endpoint = type === 'success' ? 
                    `${PAYMENT_BASE}/simulate-payment-success/${paymentId}` :
                    `${PAYMENT_BASE}/simulate-payment-failure/${paymentId}`;
                
                const response = await fetch(endpoint);
                const result = await response.json();
                
                const results = document.getElementById('paymentResults');
                results.innerHTML += `
                    <div class="status ${type === 'success' ? 'success' : 'error'}" style="margin-top: 15px;">
                        ${type === 'success' ? '‚úÖ' : '‚ùå'} ${result.message}
                        <br><strong>Status:</strong> ${result.status}
                    </div>
                `;
                
                if (type === 'success') {
                    results.innerHTML += `
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center;">
                            <h3>üéâ Buchung abgeschlossen!</h3>
                            <p>WhatsApp-Best√§tigung wird an ${leadData.whatsapp} gesendet</p>
                            <p><strong>Booking Reference:</strong> ${result.booking_reference}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Payment simulation error:', error);
            }
        }
        
        function nextStep(step) {
            // Hide current step
            document.querySelector('.funnel-step.active').classList.remove('active');
            
            // Show next step
            document.getElementById(`step${step}`).classList.add('active');
            
            // Update progress bar
            const progress = (step / 4) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            currentStep = step;
            
            // Prepare booking summary for step 4
            if (step === 4 && selectedFlight) {
                displayBookingSummary();
            }
        }
        
        function displayBookingSummary() {
            const summary = document.getElementById('bookingSummary');
            
            summary.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3>üìã Buchungs√ºbersicht</h3>
                    
                    <div style="margin: 20px 0;">
                        <h4>üë§ Passagier</h4>
                        <p>${leadData.firstName} ${leadData.lastName}</p>
                        <p>üìß ${leadData.email}</p>
                        <p>üì± ${leadData.whatsapp}</p>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>‚úàÔ∏è Flug</h4>
                        <p><strong>${selectedFlight.airline} ${selectedFlight.flightNumber}</strong></p>
                        <p>${selectedFlight.departure.airport} ‚Üí ${selectedFlight.arrival.airport}</p>
                        <p>${new Date(selectedFlight.departure.time).toLocaleString('de-DE')}</p>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>üí∞ Preis</h4>
                        <p style="font-size: 1.5rem; font-weight: bold; color: #667eea;">
                            ${selectedFlight.price.total.toFixed(2)} EUR
                        </p>
                        <p>${selectedFlight.price.perPerson.toFixed(2)} EUR pro Person (${searchData.passengers} Passagiere)</p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>